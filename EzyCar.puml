@startuml EzyCar System - Sequence Diagrams

header EzyCar - Car Service Booking Platform
footer Page %page% of %lastpage%

' ========================================
' Scenario 1: User Registration
' ========================================
title "Scenario 1: User Registration (POST /api/v1/auth/register)"

participant "User/Client" as client
participant "<<JavaScript>>\n:server" as server
participant "<<router>>\n:auth" as routerAuth
participant "<<controllers>>\n:auth" as controllersAuth
participant "<<model>>\n:User" as modelUser
database "<<MongoDB>>\n:users" as UsersDB

client -> server ++: POST /api/v1/auth/register\n{name, email, telnum, password, role}
server -> routerAuth ++: app.use('/api/v1/auth', auth)
routerAuth -> controllersAuth ++: register()
controllersAuth -> modelUser ++: User.create(userData)
modelUser -> UsersDB ++: UserSchema
UsersDB --> modelUser --: user
controllersAuth <-- modelUser --: user
controllersAuth -> controllersAuth: getSignedJwtToken()
controllersAuth -> client --: response(201)\n{success, token, data}

newpage

' ========================================
' Scenario 2: User Login
' ========================================
title "Scenario 2: User Login (POST /api/v1/auth/login)"

participant "User/Client" as client
participant "<<JavaScript>>\n:server" as server
participant "<<router>>\n:auth" as routerAuth
participant "<<controllers>>\n:auth" as controllersAuth
participant "<<model>>\n:User" as modelUser
database "<<MongoDB>>\n:users" as UsersDB

client -> server ++: POST /api/v1/auth/login\n{email, password}
server -> routerAuth ++: app.use('/api/v1/auth', auth)
routerAuth -> controllersAuth ++: login()
controllersAuth -> modelUser ++: User.findOne({email})
modelUser -> UsersDB ++: find user by email
UsersDB --> modelUser --: user
controllersAuth <-- modelUser --: user
controllersAuth -> controllersAuth: matchPassword(password)
alt password matches
    controllersAuth -> controllersAuth: getSignedJwtToken()
    controllersAuth -> client --: response(200)\n{success, token, data}
else password incorrect
    controllersAuth -> client --: response(400)\n{success: false, msg}
end

newpage

' ========================================
' Scenario 3: Admin Creates Provider
' ========================================
title "Scenario 3: Admin Creates Provider (POST /api/v1/providers)"

participant "Admin/Client" as admin
participant "<<JavaScript>>\n:server" as server
participant "<<middleware>>\n:auth" as authMiddleware
participant "<<router>>\n:providers" as routerProviders
participant "<<controllers>>\n:providers" as controllersProviders
participant "<<model>>\n:Provider" as modelProvider
database "<<MongoDB>>\n:providers" as ProvidersDB

admin -> server ++: POST /api/v1/providers\n{name, address, tel}\nAuthorization: Bearer token
server -> authMiddleware ++: protect()
authMiddleware -> authMiddleware: verify JWT token
alt token valid
    authMiddleware -> routerProviders ++: next()
    routerProviders -> authMiddleware ++: authorize('admin')
    authMiddleware -> authMiddleware: check user role
    alt role is admin
        authMiddleware -> controllersProviders ++: createProvider()
        controllersProviders -> modelProvider ++: Provider.create(req.body)
        modelProvider -> ProvidersDB ++: ProviderSchema
        ProvidersDB --> modelProvider --: provider
        controllersProviders <-- modelProvider --: provider
        controllersProviders -> admin --: response(201)\n{success, data}
    else role is not admin
        authMiddleware -> admin --: response(403)\n{success: false, msg}
    end
else token invalid
    authMiddleware -> admin --: response(401)\n{success: false, msg}
end

newpage

' ========================================
' Scenario 4: User Creates Booking
' ========================================
title "Scenario 4: User Creates Booking (POST /api/v1/bookings)"

participant "User/Client" as client
participant "<<JavaScript>>\n:server" as server
participant "<<middleware>>\n:auth" as authMiddleware
participant "<<router>>\n:bookings" as routerBookings
participant "<<controllers>>\n:bookings" as controllersBookings
participant "<<model>>\n:Provider" as modelProvider
participant "<<model>>\n:Booking" as modelBooking
database "<<MongoDB>>\n:providers" as ProvidersDB
database "<<MongoDB>>\n:bookings" as BookingsDB

client -> server ++: POST /api/v1/bookings\n{provider, bookingDate}\nAuthorization: Bearer token
server -> authMiddleware ++: protect()
authMiddleware -> authMiddleware: verify JWT token
alt token valid
    authMiddleware -> routerBookings ++: next()
    routerBookings -> authMiddleware ++: authorize('user', 'admin')
    authMiddleware -> authMiddleware: check user role
    alt role authorized
        authMiddleware -> controllersBookings ++: addBooking()
        controllersBookings -> controllersBookings: req.body.user = req.user.id
        controllersBookings -> modelProvider ++: Provider.findById(req.body.provider)
        modelProvider -> ProvidersDB ++: find provider
        ProvidersDB --> modelProvider --: provider
        controllersBookings <-- modelProvider --: provider
        alt provider exists
            controllersBookings -> modelBooking ++: Booking.find({user: req.user.id})
            modelBooking -> BookingsDB ++: count user bookings
            BookingsDB --> modelBooking --: existingBookings
            controllersBookings <-- modelBooking --: existingBookings
            alt bookings < 3 or admin
                controllersBookings -> modelBooking ++: Booking.create(req.body)
                modelBooking -> BookingsDB ++: BookingSchema
                BookingsDB --> modelBooking --: booking
                controllersBookings <-- modelBooking --: booking
                controllersBookings -> client --: response(201)\n{success, data}
            else bookings >= 3
                controllersBookings -> client --: response(400)\n{success: false, msg}
            end
        else provider not found
            controllersBookings -> client --: response(404)\n{success: false, msg}
        end
    else role not authorized
        authMiddleware -> client --: response(403)\n{success: false, msg}
    end
else token invalid
    authMiddleware -> client --: response(401)\n{success: false, msg}
end

newpage

' ========================================
' Scenario 5: User Gets Booking History
' ========================================
title "Scenario 5: User Gets Booking History (GET /api/v1/bookings/myhistory)"

participant "User/Client" as client
participant "<<JavaScript>>\n:server" as server
participant "<<middleware>>\n:auth" as authMiddleware
participant "<<router>>\n:bookings" as routerBookings
participant "<<controllers>>\n:bookings" as controllersBookings
participant "<<model>>\n:Booking" as modelBooking
database "<<MongoDB>>\n:bookings" as BookingsDB

client -> server ++: GET /api/v1/bookings/myhistory\nAuthorization: Bearer token
server -> authMiddleware ++: protect()
authMiddleware -> authMiddleware: verify JWT token
alt token valid
    authMiddleware -> routerBookings ++: next()
    routerBookings -> authMiddleware ++: authorize('user', 'admin')
    authMiddleware -> authMiddleware: check user role
    alt role authorized
        authMiddleware -> controllersBookings ++: getMyBookingHistory()
        controllersBookings -> modelBooking ++: Booking.find({user: req.user.id})\n.sort({bookingDate: -1})\n.populate('provider')
        modelBooking -> BookingsDB ++: find user bookings
        BookingsDB --> modelBooking --: bookings[]
        controllersBookings <-- modelBooking --: bookings[]
        controllersBookings -> client --: response(200)\n{success, count, data}
    else role not authorized
        authMiddleware -> client --: response(403)\n{success: false, msg}
    end
else token invalid
    authMiddleware -> client --: response(401)\n{success: false, msg}
end

newpage

' ========================================
' Scenario 6: User Cancels Booking
' ========================================
title "Scenario 6: User Cancels Booking (DELETE /api/v1/bookings/:id)"

participant "User/Client" as client
participant "<<JavaScript>>\n:server" as server
participant "<<middleware>>\n:auth" as authMiddleware
participant "<<router>>\n:bookings" as routerBookings
participant "<<controllers>>\n:bookings" as controllersBookings
participant "<<model>>\n:Booking" as modelBooking
database "<<MongoDB>>\n:bookings" as BookingsDB

client -> server ++: DELETE /api/v1/bookings/:id\nAuthorization: Bearer token
server -> authMiddleware ++: protect()
authMiddleware -> authMiddleware: verify JWT token
alt token valid
    authMiddleware -> routerBookings ++: next()
    routerBookings -> controllersBookings ++: deleteBooking()
    controllersBookings -> modelBooking ++: Booking.findById(req.params.id)
    modelBooking -> BookingsDB ++: find booking
    BookingsDB --> modelBooking --: booking
    controllersBookings <-- modelBooking --: booking
    alt booking exists
        controllersBookings -> controllersBookings: check authorization\n(owner or admin)
        alt authorized
            controllersBookings -> modelBooking ++: booking.deleteOne()
            modelBooking -> BookingsDB ++: delete booking
            BookingsDB --> modelBooking --: success
            controllersBookings <-- modelBooking --: success
            controllersBookings -> client --: response(200)\n{success, data: {}}
        else not authorized
            controllersBookings -> client --: response(401)\n{success: false, msg}
        end
    else booking not found
        controllersBookings -> client --: response(404)\n{success: false, msg}
    end
else token invalid
    authMiddleware -> client --: response(401)\n{success: false, msg}
end

@enduml
